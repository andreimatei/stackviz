<div class="app">

  <app-core>
    <!--
      Define the global key-value mapping, with it initial values.  This global state provides
      communication between components.
    -->
    <global-state>
      <value-map>
        <value key="collection_id">
          <int>1</int>
        </value>
        <value key="path_prefix">
          <string-list></string-list>
        </value>
        <value key="filter">
          <string></string>
        </value>
      </value-map>
    </global-state>

    <!--
      A handler for Data queries issued to a connected backend via HTTP.
      Multiple components may use this to subscribe to DataSeries streams;
      these will be automatically updated as new data becomes available.
    -->
    <data-query [debounceMs]="50">
      <!--
        The set of filters to attach to DataRequests.  Each specified global
        value is provided with each DataRequest under the provided query key.
        Note that backend data series providers may ignore some global filters.
      -->
      <value-map>
        <value key="collection_id"><global-ref key="collection_id"></global-ref></value>
        <value key="path_prefix"><global-ref key="path_prefix"></global-ref></value>
        <value key="filter"><global-ref key="filter"></global-ref></value>
      </value-map>
    </data-query>
  </app-core>

  <p>
    Collection <a routerLink="/collections"> {{ collectionName }} </a>
  </p>

  <mat-form-field>
    <mat-label>Snapshots</mat-label>
    <select matNativeControl required>
      <option *ngFor="let snap of snapshots" [value]="snap.id" >{{ snap.processID }}</option>
    </select>
  </mat-form-field>

  <text-field label="Filter" placeholder="filter by package or function name" updateOnEnter=false>
    <interactions>
      <action target="text_field" type="update">
        <set>
          <global-ref key="filter"></global-ref>
          <local-ref key="contents"></local-ref>
        </set>
      </action>
    </interactions>
  </text-field>

  <weighted-tree>
    <data-series>
      <query>
        <string>stacks.tree</string>
      </query>

      <interactions>
        <reaction target="data-series" type="fetch">
          <or>
            <changed><global-ref key="collection_id"></global-ref></changed>
            <changed><global-ref key="path_prefix"></global-ref></changed>
            <changed><global-ref key="filter"></global-ref></changed>
          </or>
        </reaction>
      </interactions>
    </data-series>


    <interactions>
      <action target="node" type="click">
        <set>
          <global-ref key="path_prefix"></global-ref>
          <local-ref key="path"></local-ref>
        </set>
      </action>
      <reaction target="node" type="highlight">
        <includes>
          <local-ref key="name"></local-ref>
          <string>sync.runtime_notifyListWait</string>
        </includes>
      </reaction>
    </interactions>

  </weighted-tree>

  <app-stacks>
    <data-series>
      <query>
        <string>stacks.raw</string>
      </query>

      <interactions>
        <reaction target="data-series" type="fetch">
          <or>
            <changed><global-ref key="collection_id"></global-ref></changed>
            <changed><global-ref key="path_prefix"></global-ref></changed>
            <changed><global-ref key="filter"></global-ref></changed>
          </or>
        </reaction>
      </interactions>
    </data-series>
  </app-stacks>
</div>
