<div class="app">
  <mat-sidenav-container class="example-container" autosize>
    <mat-sidenav #functionDrawer mode="side" position="end"
                 class="func-details-drawer"
                 mode="side"
                 mwlResizable
                 [enableGhostResize]="true"
                 [ngStyle]="style"
                 [validateResize]="validateResize"
                 (resizeEnd)="onResizeEnd($event)"
    >
      <div
        class="resize-handle-left"
        mwlResizeHandle
        [resizeEdges]="{ left: true }"
      >
      </div>


      <div style="padding-left: 5px;">
        <div style="display: flex; flex-flow: row; justify-content: space-between;">
          <h2>Function details</h2>
          <button mat-icon-button mat-dialog-close (click)="closeSidebar()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <b>
          {{selectedFrame?.name}}
        </b>
        <pre>{{selectedFrame?.file}}:{{selectedFrame?.line}}</pre>
      </div>


      <mat-expansion-panel expanded style="margin-left: 5px">

        <mat-expansion-panel-header>
          <mat-panel-title>
            Available variables
          </mat-panel-title>
          <mat-panel-description>
            The variables available in this frame.
          </mat-panel-description>
        </mat-expansion-panel-header>

        <mat-progress-bar mode="indeterminate" *ngIf="loadingAvailableVars"></mat-progress-bar>
        <type-info (checkedChange)="checkedChange($event)"/>
      </mat-expansion-panel>

      <mat-expansion-panel expanded style="margin-left: 5px">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Captured variables
          </mat-panel-title>
          <mat-panel-description>
            The variables captured from all stack traces featuring this frame.
          </mat-panel-description>
        </mat-expansion-panel-header>

        <mat-accordion multi>
          <mat-expansion-panel expanded *ngFor="let v of funcInfo">
            <mat-expansion-panel-header>
              <mat-panel-title>
                Frame info
              </mat-panel-title>
            </mat-expansion-panel-header>
            {{v}}
          </mat-expansion-panel>
        </mat-accordion>
      </mat-expansion-panel>
    </mat-sidenav>

    <mat-sidenav-content>
      <app-core>
        <!--
          Define the global key-value mapping, with it initial values.  This global state provides
          communication between components.
        -->
        <global-state>
          <value-map>
            <value key="path_prefix">
              <string-list></string-list>
            </value>
            <value key="filter">
              <string></string>
            </value>
          </value-map>
        </global-state>

        <!--
          A handler for Data queries issued to a connected backend via HTTP.
          Multiple components may use this to subscribe to DataSeries streams;
          these will be automatically updated as new data becomes available.
        -->
        <data-query [debounceMs]="50">
          <!--
            The set of filters to attach to DataRequests.  Each specified global
            value is provided with each DataRequest under the provided query key.
            Note that backend data series providers may ignore some global filters.
          -->
          <value-map>
            <value key="collection_id">
              <global-ref key="collection_id"></global-ref>
            </value>
            <value key="snapshot_id">
              <global-ref key="snapshot_id"></global-ref>
            </value>
            <value key="path_prefix">
              <global-ref key="path_prefix"></global-ref>
            </value>
            <value key="filter">
              <global-ref key="filter"></global-ref>
            </value>
          </value-map>
        </data-query>
      </app-core>

      <p>
        Collection <a routerLink="/collections"> {{ collectionName }} </a>
        Snapshot ID: {{snapshotID}}
      </p>

      <mat-form-field>
        <mat-label>Snapshots</mat-label>
        <mat-select #snapshotsSelect
                    (selectionChange)="onSelectedSnapshotChange(snapshotsSelect.value)"
                    [value]="snapshotID.toString()"
        >
          <mat-option *ngFor="let snap of snapshots" [value]="snap.id">{{ snap.processID }}</mat-option>
        </mat-select>
      </mat-form-field>

      <app-flamegraph [colID]="collectionID" [snapID]="snapshotID"> </app-flamegraph>
<!--      <app-flamegraph [colId]="collectionID" [snapID]="snapshotID"> </app-flamegraph>-->

      <text-field label="Filter" placeholder="filter by package or function name"
                  updateOnEnter=false>
        <interactions>
          <action target="text_field" type="update">
            <set>
              <global-ref key="filter"></global-ref>
              <local-ref key="contents"></local-ref>
            </set>
          </action>
        </interactions>
      </text-field>

      <weighted-tree>

        <data-series>
          <query>
            <string>stacks.tree</string>
          </query>

          <interactions>
            <reaction target="data-series" type="fetch">
              <or>
                <changed>
                  <global-ref key="snapshot_id"></global-ref>
                </changed>
                <changed>
                  <global-ref key="path_prefix"></global-ref>
                </changed>
                <changed>
                  <global-ref key="filter"></global-ref>
                </changed>
              </or>
            </reaction>
          </interactions>
        </data-series>

        <interactions>
          <action target="node" type="click">
            <set>
              <global-ref key="path_prefix"></global-ref>
              <local-ref key="path"></local-ref>
            </set>
          </action>
          <action target="node" type="ctrl-click">
          </action>
        </interactions>
      </weighted-tree>

      <app-stacks [colID]="collectionID" [snapID]="snapshotID">
        <data-series>
          <query>
            <string>stacks.raw</string>
          </query>

          <interactions>
            <reaction target="data-series" type="fetch">
              <or>
                <changed>
                  <global-ref key="snapshot_id"></global-ref>
                </changed>
                <changed>
                  <global-ref key="path_prefix"></global-ref>
                </changed>
                <changed>
                  <global-ref key="filter"></global-ref>
                </changed>
              </or>
            </reaction>
          </interactions>
        </data-series>
      </app-stacks>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>
